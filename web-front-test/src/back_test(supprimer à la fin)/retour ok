import { useEffect, useState } from "react";
import {
  MapContainer,
  TileLayer,
  Polyline,
  Marker,
  Popup,
  ZoomControl,
  useMapEvents,
  useMap,
} from "react-leaflet";
import L from "leaflet";
import "leaflet/dist/leaflet.css";
import "./RoutingMap.css";
import { decodePolyline } from "../../utils/decodePolyline";

// Fix icônes Leaflet
delete L.Icon.Default.prototype._getIconUrl;
L.Icon.Default.mergeOptions({
  iconRetinaUrl: require("leaflet/dist/images/marker-icon-2x.png"),
  iconUrl: require("leaflet/dist/images/marker-icon.png"),
  shadowUrl: require("leaflet/dist/images/marker-shadow.png"),
});

// Gestion du clic sur la carte
function MapClickHandler({ onClick }) {
  useMapEvents({
    click: onClick,
  });
  return null;
}

// Auto-fit entre les deux points
function FitBounds({ start, end }) {
  const map = useMap();
  useEffect(() => {
    if (start && end) {
      const bounds = L.latLngBounds([start, end]);
      map.fitBounds(bounds, { padding: [50, 50] });
    }
  }, [start, end, map]);
  return null;
}

export default function RouteMap() {
  const [startPoint, setStartPoint] = useState(null);
  const [endPoint, setEndPoint] = useState(null);
  const [routeData, setRouteData] = useState(null);
  const [decodedCoords, setDecodedCoords] = useState([]);
  const [maneuvers, setManeuvers] = useState([]);
  const [summary, setSummary] = useState({ length: 0, time: 0 });

  const [transportMode, setTransportMode] = useState("auto");
  const [avoidTolls, setAvoidTolls] = useState(false);
  const [avoidHighways, setAvoidHighways] = useState(false);
  const [avoidFerries, setAvoidFerries] = useState(false);
  const [units, setUnits] = useState("kilometers");
  const [language, setLanguage] = useState("fr-FR");

  const [loading, setLoading] = useState(false);
  const [error, setError] = useState(null);

  const handleMapClick = (e) => {
    const { lat, lng } = e.latlng;
    if (!startPoint) {
      setStartPoint([lat, lng]);
    } else if (!endPoint) {
      setEndPoint([lat, lng]);
    } else {
      setStartPoint([lat, lng]);
      setEndPoint(null);
      setDecodedCoords([]);
      setManeuvers([]);
      setSummary({ length: 0, time: 0 });
    }
  };

  const fetchRoute = async () => {
    if (!startPoint || !endPoint) return;
    setLoading(true);
    setError(null);

    const url = "http://localhost/api/navigation/route";
    const body = {
      locations: [
        { lat: startPoint[0], lon: startPoint[1] },
        { lat: endPoint[0], lon: endPoint[1] },
      ],
      costing: transportMode,
      costing_options: {
        [transportMode]: {
          use_tolls: avoidTolls ? 0 : 1,
          avoid_highways: avoidHighways ? 1 : 0,
          avoid_ferries: avoidFerries ? 1 : 0,
        },
      },
      directions_options: {
        language,
        units,
      },
      alternates: true,
    };

    try {
      const response = await fetch(url, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(body),
      });

      if (!response.ok) throw new Error("Erreur réseau");
      const data = await response.json();
      setRouteData(data);

      const shape = data.trip.legs[0].shape;
      const decoded = decodePolyline(shape);
      setDecodedCoords(decoded);
      setManeuvers(data.trip.legs[0].maneuvers);
      setSummary(data.trip.summary);
    } catch (error) {
      setError("Erreur lors de la récupération de l'itinéraire");
      console.error(error);
    } finally {
      setLoading(false);
    }
  };

  const displayDistance = (len) => {
    return units === "miles"
      ? `${len.toFixed(2)} mi`
      : `${(len * 1.60934).toFixed(2)} km`;
  };

  useEffect(() => {
    fetchRoute();
  }, [startPoint, endPoint, transportMode, avoidTolls, avoidHighways, avoidFerries, units, language]);

  return (
    <div style={{ display: "flex", height: "100vh", width: "100%" }}>
      {/* Carte */}
      <div style={{ flex: 4 }}>
        <MapContainer
          center={startPoint || [45.7486, 4.8258]}
          zoom={14}
          style={{ height: "100%", width: "100%" }}
          zoomControl={false}
        >
          <MapClickHandler onClick={handleMapClick} />
          {startPoint && endPoint && <FitBounds start={startPoint} end={endPoint} />}

          <TileLayer
            url="https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png"
            attribution='&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>'
          />
          <ZoomControl position="bottomright" />

          {startPoint && (
            <Marker position={startPoint}>
              <Popup>Point de départ</Popup>
            </Marker>
          )}

          {endPoint && (
            <Marker position={endPoint}>
              <Popup>Point d'arrivée</Popup>
            </Marker>
          )}

          {decodedCoords.length > 0 && (
            <>
              <Polyline positions={decodedCoords} color="blue" weight={5} opacity={0.7} />
              {maneuvers.map((maneuver, index) => {
                const pos = decodedCoords[maneuver.begin_shape_index];
                if (!pos) return null;
                return (
                  <Marker
                    key={index}
                    position={pos}
                    icon={L.divIcon({
                      className: "custom-icon",
                      html: `<div class="custom-icon">${index + 1}</div>`,
                      iconSize: [20, 20],
                    })}
                  >
                    <Popup>
                      <strong>Étape {index + 1}:</strong> {maneuver.instruction}
                      <br />
                      Distance: {displayDistance(maneuver.length)}
                      <br />
                      Durée: {Math.round(maneuver.time / 60)} minutes
                    </Popup>
                  </Marker>
                );
              })}
            </>
          )}
        </MapContainer>
      </div>

      {/* Contrôles */}
      <div className="sidebar">
        <h3>Options d'itinéraire</h3>

        <label htmlFor="transport">Mode de transport:</label>
        <select id="transport" value={transportMode} onChange={(e) => setTransportMode(e.target.value)}>
          <option value="auto">Voiture</option>
          <option value="bicycle">Vélo</option>
          <option value="pedestrian">À pied</option>
          <option value="motor_scooter">Moto</option>
        </select>

        <div>
          <label>
            <input
              type="checkbox"
              checked={avoidTolls}
              onChange={(e) => setAvoidTolls(e.target.checked)}
              aria-label="Éviter les péages"
            />
            Éviter les péages
          </label>
        </div>

        <div>
          <label>
            <input
              type="checkbox"
              checked={avoidHighways}
              onChange={(e) => setAvoidHighways(e.target.checked)}
              aria-label="Éviter les autoroutes"
            />
            Éviter les autoroutes
          </label>
        </div>

        <div>
          <label>
            <input
              type="checkbox"
              checked={avoidFerries}
              onChange={(e) => setAvoidFerries(e.target.checked)}
              aria-label="Éviter les ferries"
            />
            Éviter les ferries
          </label>
        </div>

        <label htmlFor="unit">Unités:</label>
        <select id="unit" value={units} onChange={(e) => setUnits(e.target.value)}>
          <option value="kilometers">Kilomètres</option>
          <option value="miles">Miles</option>
        </select>

        <label htmlFor="lang">Langue:</label>
        <select id="lang" value={language} onChange={(e) => setLanguage(e.target.value)}>
          <option value="fr-FR">Français</option>
          <option value="en-US">Anglais</option>
          <option value="de-DE">Allemand</option>
          <option value="es-ES">Espagnol</option>
        </select>

        {loading && <p>Chargement de l'itinéraire...</p>}
        {error && <p style={{ color: "red" }}>{error}</p>}
      </div>

      {/* Résumé */}
      <div className="route-summary">
        <h3>Récapitulatif</h3>
        <p>Distance totale: {summary.length ? displayDistance(summary.length) : "-"}</p>
        <p>Temps estimé: {summary.time ? Math.round(summary.time / 60) + " minutes" : "-"}</p>
      </div>
    </div>
  );
}
